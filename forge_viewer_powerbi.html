<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>APS 3D Viewer</title>
  <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css">
  <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; overflow: hidden; }

    #viewer {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    /* ========== MAKE AUTODESK INBUILT ICONS SMALLER ========== */
  /* Button container - 30% size */
.adsk-viewing-viewer .adsk-button,
.adsk-control-group .adsk-button {
  width: 20px !important;
  height: 20px !important;
  min-width: 20px !important;
  min-height: 20px !important;
  margin: 1px !important;
  padding: 0 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  overflow: visible !important;  /* Changed from hidden to visible for scaled icons */
  line-height: 20px !important;
}

/* Icons - 70% scale (comprehensive targeting) */
.adsk-viewing-viewer .adsk-button .adsk-icon,
.adsk-viewing-viewer .adsk-button svg,
.adsk-viewing-viewer .adsk-button img,
.adsk-control-group .adsk-button .adsk-icon,
.adsk-control-group .adsk-button svg,
.adsk-control-group .adsk-button img {
  transform: scale(0.1) !important;
  transform-origin: center center !important;
  flex-shrink: 0 !important;
}

/* Ensure SVG paths and children also scale */
.adsk-viewing-viewer .adsk-button .adsk-icon *,
.adsk-viewing-viewer .adsk-button svg *,
.adsk-control-group .adsk-button .adsk-icon *,
.adsk-control-group .adsk-button svg * {
  transform: scale(1) !important;  /* Reset to prevent double-scaling */
}

/* Toolbar height */
.adsk-viewing-viewer .adsk-toolbar,
.adsk-toolbar-group,
.adsk-control-group {
  height: auto !important;
  padding: 1px !important;
}

/* Toolbar alignment */
.adsk-viewing-viewer .adsk-toolbar-group {
  display: flex !important;
  align-items: center !important;
}

/* ViewCube - 30% size */
.adsk-viewing-viewer .homeViewWrapper {
  width: 20px !important;
  height: 20px !important;
}

.adsk-viewing-viewer .homeViewWrapper canvas {
  width: 20px !important;
  height: 20px !important;
}

    /* ========================================================= */

    /* ======= DROPDOWN MENU - ADJUSTED SIZE ======= */
    .dropdown {
      position: absolute;
      top: 25px;
      right: 10px;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dropdown-button {
      width: 25px;        /* Changed from 1.5cm */
      height: 25px;       /* Changed from 1.5cm */
      border: none;
      border-radius: 50px; /* Changed from 50% for rounded square */
      background: #3498db;
      color: white;
      font-size: 12px;    /* Adjusted size */
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dropdown-button:hover {
      background: #2980b9;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 25px;          /* Adjusted for new button size */
      right: 0;
      background-color: rgba(255,255,255,0.97);
      min-width: 50px;   /* Made slightly wider */
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      border-radius: 10px;
      overflow: hidden;
      font-size: 10px;
      animation: fadeIn 0.2s ease-in-out;
    }

    .dropdown-content button {
      display: flex;
      align-items: center;
      width: 100%;
      background: none;
      border: none;
      padding: 5px 5px; /* Slightly more padding */
      cursor: pointer;
      text-align: left;
      font-size: 10px;    /* Slightly larger */
      color: #333;
      transition: background 0.2s;
    }

    .dropdown-content button:hover {
      background: #f1f1f1;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #status {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      padding: 8px 12px;
      border-radius: 6px;
      color: white;
      background: #3498db;
      font-size: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #model-name {
      position: absolute;
      top: 2px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      background: #004E43;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      text-align: center;
      letter-spacing: 0.5px;
      padding: 6px 12px;
      line-height: normal;
      height: auto;
    }

    #company-logo {
    position: fixed;
    top: 0px;
    left: 0px;
    z-index: 9999;
    height: 40px;
    width: auto;
    background: white;
    padding: 5px;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    display: block !important;
    visibility: visible !important;
}

    #info {
      position: absolute;
      bottom: 2px;
      left: 2px;
      z-index: 100;
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      width: 200px;
      max-height: 300px;
      display: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      font-size: 10px;
      resize: both;
      overflow: hidden;
      min-width: 120px;
      min-height: 100px;
    }

    #info-header {
      background: #004E43;
      color: white;
      padding: 4px 6px;
      border-radius: 4px 4px 0 0;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      font-size: 11px;
      font-weight: bold;
    }

    #closeBtn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      margin-left: 8px;
    }

    #closeBtn:hover {
      background: rgba(255,255,255,0.4);
    }

    #info-content {
      padding: 5px;
      overflow-y: auto;
      max-height: 250px;
      font-size: 10px;
    }

    #info::after {
      content: '⋰';
      position: absolute;
      bottom: 2px;
      right: 2px;
      color: #999;
      font-size: 12px;
      pointer-events: none;
    }

    .error { background: #e74c3c !important; }
    .success { background: #2ecc71 !important; }

    /* ========== PUSHPIN STYLES ========== */
    .custom-pushpin {
      position: absolute;
      width: 15px;
      height: 15px;
      background: #e74c3c;
      border: 0px solid white;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.2s;
      z-index: 50;
    }

    .custom-pushpin:hover {
      transform: scale(1.3);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    .custom-pushpin.selected {
      background: #2ecc71;
      transform: scale(1.4);
      z-index: 1000;
    }
  </style>
</head>
<body>
<body>
  <div id="viewer"></div>
  <img id="company-logo" src="data:image/png;base64,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" alt="Logo" />
  <div id="status">Initializing...</div>
  <div id="model-name">Loading model...</div>
  
  <!-- Dropdown Menu -->
  <div class="dropdown">
    <button class="dropdown-button">☰</button>
    <div class="dropdown-content" id="dropdownMenu">
      <button onclick="resetView()">🔄 Reset View</button>
      <button onclick="fitToView()">📐 Fit to View</button>
      <button onclick="showAll()">👁️ Show All</button>
      <button onclick="togglePushpins()">📍 Toggle Pushpins</button>
      <button onclick="toggleInfo()">ℹ️ Info Panel</button>
    </div>
  </div>

  <div id="info">
    <div id="info-header">
      Info Panel
      <button id="closeBtn">×</button>
    </div>
    <div id="info-content"></div>
  </div>

  <script>
    let viewer = null;
    let currentModel = null;
    let pushpins = [];
    let issuesData = [];
    let pushpinsVisible = true;
    let selectedPushpin = null;
    let currentModelUrn = null;
    let loadingModel = false;
    let currentViewableGuid = null;
    
    // ========== VIEWER INITIALIZATION ==========
    async function initViewer() {
      const statusDiv = document.getElementById('status');
      try {
        updateStatus('Getting access token...', 'status');
        const tokenResp = await fetch('/api/token');
        const tokenData = await tokenResp.json();

        updateStatus('Getting model URN...', 'status');
        
        // Get the first issue's viewable to load initial model
        const issuesResp = await fetch('/api/issues');
        const issuesData = await issuesResp.json();
        
        let initialUrn = null;
        let initialModelName = 'Model';
        
        if (issuesData && issuesData.length > 0) {
          const firstIssue = issuesData[0];
          const viewableGuid = firstIssue.viewable_guid;
          
          if (viewableGuid) {
            console.log('🔍 Getting URN for first issue viewable:', viewableGuid);
            const modelResp = await fetch(`/api/model-urn-for-viewable?viewable_guid=${viewableGuid}`);
            if (modelResp.ok) {
              const modelData = await modelResp.json();
              initialUrn = modelData.urn;
              initialModelName = modelData.model_name;
              console.log('✅ Will load:', initialModelName);
              console.log('🔍 Full modelData:', modelData);
            }
          }
        }
        
        // Fallback to old method if above fails
        if (!initialUrn) {
          const urnResp = await fetch('/api/model-urn');
          const urnData = await urnResp.json();
          initialUrn = urnData.urn;
          initialModelName = urnData.filename || 'Model';
        }
        
        const urnData = { urn: initialUrn, filename: initialModelName };
        currentModelUrn = initialUrn;
        
        // Update model name display
        const modelNameDiv = document.getElementById('model-name');
        if (modelNameDiv && urnData.filename) {
          modelNameDiv.textContent = urnData.filename;
          console.log('Model name set to:', urnData.filename);
        }

        // Set initial viewable GUID from first issue
        if (issuesData && issuesData.length > 0 && issuesData[0].viewable_guid) {
          currentViewableGuid = issuesData[0].viewable_guid;
          console.log('🔑 Initial viewable GUID:', currentViewableGuid);
        }

        const options = {
          env: 'AutodeskProduction',
          api: 'derivativeV2',
          accessToken: tokenData.access_token
        };

        Autodesk.Viewing.Initializer(options, function() {
          const viewerDiv = document.getElementById('viewer');
          viewer = new Autodesk.Viewing.GuiViewer3D(viewerDiv);
          if (viewer.start() > 0) {
            updateStatus('❌ Failed to start viewer', 'error');
            return;
          }
          const documentId = 'urn:' + urnData.urn;
          Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
        });
      } catch (error) {
        console.error(error);
        updateStatus('❌ ' + error.message, 'error');
      }
    }

    function onDocumentLoadSuccess(doc) {
      const viewable = doc.getRoot().getDefaultGeometry();
      viewer.loadDocumentNode(doc, viewable).then(model => {
        currentModel = model;
        
        updateStatus('✅ Model loaded!', 'success');
        setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
        viewer.addEventListener(Autodesk.Viewing.SELECTION_CHANGED_EVENT, onSelectionChanged);
        
        // Load issues and create pushpins
        loadIssuesAndCreatePushpins();
      });
    }

    function onDocumentLoadFailure(code, msg) {
      updateStatus('❌ Failed to load: ' + msg, 'error');
    }

    // ========== PUSHPINS FUNCTIONALITY ==========
    async function loadIssuesAndCreatePushpins() {
      try {
        updateStatus('Loading issues...', 'status');
        
        const response = await fetch('/api/issues');
        const data = await response.json();
        
        issuesData = data;
        
        // Filter issues that have coordinates AND belong to current model
        let issuesWithCoords = data.filter(issue => 
          issue.pin_x && issue.pin_y && issue.pin_z
        );
        
        // If a specific model is loaded, filter by viewable_guid
        if (currentViewableGuid) {
          const beforeFilter = issuesWithCoords.length;
          issuesWithCoords = issuesWithCoords.filter(issue => 
            issue.viewable_guid === currentViewableGuid
          );
          console.log(`🔍 Filtered issues: ${beforeFilter} → ${issuesWithCoords.length} (viewable_guid: ${currentViewableGuid})`);
        } else {
          console.log(`Found ${issuesWithCoords.length} issues with coordinates (no filter)`);
        }
        
        if (issuesWithCoords.length > 0) {
          createPushpins(issuesWithCoords);
          updateStatus(`✅ Loaded ${issuesWithCoords.length} pushpins`, 'success');
          setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
        }
        
      } catch (error) {
        console.error('Error loading issues:', error);
        updateStatus('⚠️ Could not load issues', 'error');
      }
    }

    function createPushpins(issues) {
      // Clear existing pushpins
      clearPushpins();
      
      issues.forEach((issue, index) => {
        const x = parseFloat(issue.pin_x);
        const y = parseFloat(issue.pin_y);
        const z = parseFloat(issue.pin_z);
        
        if (isNaN(x) || isNaN(y) || isNaN(z)) {
          return;
        }
        
        const position = new THREE.Vector3(x, y, z);
        
        // Create pushpin element
        const pushpinDiv = document.createElement('div');
        pushpinDiv.className = 'custom-pushpin';
        pushpinDiv.textContent = issue.display_id || (index + 1);
        pushpinDiv.title = issue.title || 'Issue';
        pushpinDiv.dataset.issueId = issue.issue_id;
        
        // Add click handler
        pushpinDiv.addEventListener('click', (e) => {
          e.stopPropagation();
          selectPushpin(pushpinDiv, position, issue);
        });
        
        // Add to viewer container
        viewer.container.appendChild(pushpinDiv);
        
        // Position update function
        function updatePushpinPosition() {
          if (!viewer || !viewer.impl) return;
          
          const screenPoint = viewer.worldToClient(position);
          
          if (screenPoint) {
            pushpinDiv.style.left = (screenPoint.x - 15) + 'px';
            pushpinDiv.style.top = (screenPoint.y - 15) + 'px';
            pushpinDiv.style.display = pushpinsVisible ? 'flex' : 'none';
          }
        }
        
        // Update on camera change
        viewer.addEventListener(Autodesk.Viewing.CAMERA_CHANGE_EVENT, updatePushpinPosition);
        viewer.addEventListener(Autodesk.Viewing.VIEWER_RESIZE_EVENT, updatePushpinPosition);
        
        // Initial position
        updatePushpinPosition();
        
        // Store pushpin data
        pushpins.push({
          element: pushpinDiv,
          position: position,
          issue: issue,
          updatePosition: updatePushpinPosition
        });
      });
      
      console.log(`Created ${pushpins.length} pushpins`);
    }

    function clearPushpins() {
      pushpins.forEach(pin => {
        if (pin.element && pin.element.parentNode) {
          pin.element.parentNode.removeChild(pin.element);
        }
      });
      pushpins = [];
      selectedPushpin = null;
    }

    function selectPushpin(pushpinElement, position, issue) {
      // Deselect previous
      if (selectedPushpin) {
        selectedPushpin.classList.remove('selected');
      }
      
      // Select new
      pushpinElement.classList.add('selected');
      selectedPushpin = pushpinElement;
      
      // Focus on position
      focusOnPosition(position);
      
      // Show issue info
      showIssueDetails(issue);
    }

    function focusOnPosition(position) {
      if (!viewer) return;
      
      // Better zoom: closer and smoother
      const distance = 30; // Changed from 50 - gets closer to the pushpin
      const camera = viewer.navigation.getCamera();
      const direction = camera.position.clone().sub(position).normalize();
      const newPos = position.clone().add(direction.multiplyScalar(distance));
      
      viewer.navigation.setView(newPos, position);
      viewer.navigation.setVerticalFov(40, true); // Add zoom effect
    }

    function showIssueDetails(issue) {
      let info = `<strong>${issue.title || 'Issue'}</strong><br>`;
      info += `<small>ID: ${issue.display_id}</small><br><br>`;
      info += `<strong>Status:</strong> ${issue.status}<br>`;
      info += `<strong>Severity:</strong> ${issue.severity || 'N/A'}<br>`;
      info += `<strong>Assigned to:</strong> ${issue.assigned_to || 'Unassigned'}<br>`;
      info += `<strong>Created by:</strong> ${issue.created_by}<br>`;
      
      if (issue.description) {
        info += `<br><strong>Description:</strong><br>${issue.description}<br>`;
      }
      
      if (issue.comment_count > 0) {
        info += `<br><strong>Comments (${issue.comment_count}):</strong><br>`;
        if (issue.comment_1) {
          info += `• ${issue.comment_1_by}: ${issue.comment_1}<br>`;
        }
      }
      
      const infoContent = document.getElementById('info-content');
      const infoDiv = document.getElementById('info');
      infoContent.innerHTML = info;
      infoDiv.style.display = 'block';
    }

    function togglePushpins() {
      pushpinsVisible = !pushpinsVisible;
      pushpins.forEach(pin => {
        pin.element.style.display = pushpinsVisible ? 'flex' : 'none';
      });
      updateStatus(pushpinsVisible ? '📍 Pushpins shown' : '📍 Pushpins hidden', 'success');
      setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
      closeDropdown();
    }

    function onSelectionChanged(event) {
      if (event.dbIdArray?.length > 0) {
        viewer.getProperties(event.dbIdArray[0], props => showElementInfo(props));
      } else {
        // Don't clear info if a pushpin is selected
        if (!selectedPushpin) {
          document.getElementById('info-content').innerHTML = '';
        }
      }
    }

    function showElementInfo(props) {
      let info = `<strong>${props.name || 'Element'}</strong><br>`;
      info += `<small>ID: ${props.externalId || props.dbId}</small><br><br>`;
      props.properties?.forEach(p => {
        info += `${p.displayName}: ${p.displayValue}<br>`;
      });
      const infoContent = document.getElementById('info-content');
      const infoDiv = document.getElementById('info');
      infoContent.innerHTML = info;
      infoDiv.style.display = 'block';
    }

    function updateStatus(msg, cls) {
      const div = document.getElementById('status');
      div.textContent = msg;
      div.className = cls;
      div.style.display = 'block';
    }

    function resetView() {
      viewer?.clearSelection();
      viewer?.showAll();
      viewer?.fitToView();
      if (selectedPushpin) {
        selectedPushpin.classList.remove('selected');
        selectedPushpin = null;
      }
      closeDropdown();
      updateStatus('View reset', 'success');
      setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
    }

    function fitToView() {
      viewer?.fitToView();
      closeDropdown();
      updateStatus('Fitted to view', 'success');
      setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
    }

    function showAll() {
      viewer?.showAll();
      closeDropdown();
      updateStatus('All objects visible', 'success');
      setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
    }

    function toggleInfo() {
      const info = document.getElementById('info');
      if (info.style.display === 'none' || info.style.display === '') {
        info.style.display = 'block';
      } else {
        info.style.display = 'none';
      }
      closeDropdown();
    }

    // ======= Dropdown Logic =======
    const dropdownButton = document.querySelector('.dropdown-button');
    const dropdownMenu = document.getElementById('dropdownMenu');

    dropdownButton.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    });

    window.addEventListener('click', () => dropdownMenu.style.display = 'none');
    function closeDropdown() { dropdownMenu.style.display = 'none'; }

async function loadModelAndNavigate(issueData) {
    if (loadingModel) {
      console.log('⏳ Model already loading...');
      return;
    }
    
    const { viewable_guid, viewable_name, pin_x, pin_y, pin_z, display_id, issue_id } = issueData;
    
    try {
      // Update model name
      // Get URN for this viewable
      updateStatus(`Getting model info...`, 'status');
      const response = await fetch(`/api/model-urn-for-viewable?viewable_guid=${viewable_guid}`);

      if (!response.ok) {
        throw new Error('Failed to get model URN');
      }

      const data = await response.json();

      // Update model name with the CORRECT name from API
      updateModelName(data.model_name || data.viewable_name || viewable_name);
      console.log('🏷️ Model name from API:', data.model_name);
      
      if (!data.urn) {
        updateStatus('❌ No URN found', 'error');
        return;
      }
      
      console.log('📦 Model URN:', data.urn);
      console.log('🔑 Viewable GUID:', viewable_guid);
      
      // Store current viewable GUID
      currentViewableGuid = viewable_guid;  // ADD THIS LINE
        
        // Check if different model
        if (currentModelUrn !== data.urn) {
          console.log('🔄 Loading new model:', data.model_name);
          loadingModel = true;
          currentModelUrn = data.urn;
          
          updateStatus(`Loading ${data.model_name}...`, 'status');
          
          // Unload current model
          if (currentModel) {
            viewer.unloadModel(currentModel);
            clearPushpins();
          }
          
          // Load new model
          const documentId = 'urn:' + data.urn;
          
          Autodesk.Viewing.Document.load(
            documentId,
            (doc) => onNewModelLoadSuccess(doc, issueData),
            (errorCode, errorMsg) => {
              console.error('❌ Failed:', errorCode, errorMsg);
              updateStatus('❌ Failed to load model', 'error');
              loadingModel = false;
            }
          );
        } else {
          console.log('✅ Same model, navigating');
          navigateToIssue(issueData);
        }
        
      } catch (error) {
        console.error('❌ Error:', error);
        updateStatus('❌ Error: ' + error.message, 'error');
        loadingModel = false;
      }
    }

    function onNewModelLoadSuccess(doc, issueData) {
      const viewable = doc.getRoot().getDefaultGeometry();
      
      viewer.loadDocumentNode(doc, viewable).then(model => {
        currentModel = model;
        loadingModel = false;
        
        console.log('✅ Model loaded');
        updateStatus(`✅ Model loaded`, 'success');
        
        // Reload pushpins
        loadIssuesAndCreatePushpins().then(() => {
          setTimeout(() => navigateToIssue(issueData), 500);
        });
      }).catch(error => {
        console.error('❌ Error loading model:', error);
        updateStatus('❌ Error loading model', 'error');
        loadingModel = false;
      });
    }

    function navigateToIssue(issueData) {
      const { pin_x, pin_y, pin_z, display_id, issue_id, viewable_name } = issueData;
      
      // if (viewable_name) {
      //   updateModelName(viewable_name);
      // }
      
      if (pin_x && pin_y && pin_z) {
        const x = parseFloat(pin_x);
        const y = parseFloat(pin_y);
        const z = parseFloat(pin_z);
        
        if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
          const position = new THREE.Vector3(x, y, z);
          focusOnPosition(position);
          
          const pushpin = pushpins.find(p => p.issue.issue_id === issue_id);
          if (pushpin) {
            selectPushpin(pushpin.element, position, pushpin.issue);
          }
          
          updateStatus(`✅ Navigated to Issue ${display_id}`, 'success');
          setTimeout(() => document.getElementById('status').style.display = 'none', 2000);
        }
      }
    }

      function updateModelName(viewable_name) {
        const modelNameDiv = document.getElementById('model-name');
        
        // DON'T update if the name is a placeholder
        if (!viewable_name || viewable_name === '{3D}' || viewable_name === '3D') {
          console.log('⚠️ REJECTED bad model name:', viewable_name);
          return;  // Keep the existing good name
        }
        
        if (modelNameDiv && viewable_name) {
          let modelName = viewable_name;
          if (modelName.includes('.')) {
            modelName = modelName.split('.')[0];
          }
          console.log('✅ Updating model name to:', modelName);
          modelNameDiv.textContent = modelName;
        }
      }

    // ========== POWER BI INTEGRATION ==========
// Listen for messages from ANY window (including sibling iframes via parent)
// ✅ Unified navigation and filter message handler
    function handleNavigationMessage(event) {
      console.log('📨 Received message:', event.data);

      // ---------- LOAD AND NAVIGATE ----------
      if (event.data && event.data.type === 'LOAD_MODEL_AND_NAVIGATE') {
        console.log('🚀 Loading model and navigating...');
        loadModelAndNavigate(event.data);
        return;
      }

      // ---------- NAVIGATE TO ISSUE ----------
      if (event.data && event.data.type === 'NAVIGATE_TO_ISSUE') {
        console.log('🎯 Navigating to issue...');
        const { issue_id, display_id, pin_x, pin_y, pin_z, title, viewable_name } = event.data;
        
        // Update model name display
        if (viewable_name) {
          const modelNameDiv = document.getElementById('model-name');
          if (modelNameDiv) {
            modelNameDiv.textContent = viewable_name;
            console.log('✅ Model name updated to:', viewable_name);
          }
        }
        
        if (pin_x && pin_y && pin_z) {
          const x = parseFloat(pin_x);
          const y = parseFloat(pin_y);
          const z = parseFloat(pin_z);
          
          if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
            const position = new THREE.Vector3(x, y, z);
            focusOnPosition(position);
            
            const pushpin = pushpins.find(p => p.issue.issue_id === issue_id);
            if (pushpin) {
              selectPushpin(pushpin.element, position, pushpin.issue);
            }
            
            const displayName = display_id || title || issue_id;
            updateStatus(`✅ Navigated to Issue ${displayName}`);
            setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
          }
        }
      }

      // ---------- FILTER ISSUES ----------
      if (event.data && event.data.type === 'FILTER_ISSUES') {
        const filters = event.data.filters;
        console.log('🔍 Received filter:', filters);

        let filteredIssues = issuesData.slice();

        // Apply user filters
        for (let column in filters) {
          filteredIssues = filteredIssues.filter(issue => {
            return filters[column].includes(issue[column]);
          });
        }

        // Filter by coordinates
        let issuesWithCoords = filteredIssues.filter(issue => 
          issue.pin_x && issue.pin_y && issue.pin_z
        );

        // Filter by current model (if one is loaded)
        if (currentViewableGuid) {
          issuesWithCoords = issuesWithCoords.filter(issue => 
            issue.viewable_guid === currentViewableGuid
          );
          console.log(`🔍 Filtered to current model: ${issuesWithCoords.length} issues`);
        }

        // Rebuild pushpins
        createPushpins(issuesWithCoords);
      }
    }

    // ---------- Register Message Listeners ----------
    window.addEventListener('message', handleNavigationMessage);

    // Also relay messages from parent to this window (in case parent receives them)
    if (window.parent !== window) {
      try {
        window.parent.addEventListener('message', function(event) {
          window.postMessage(event.data, '*');
        });
      } catch (e) {
        console.log('Cannot relay from parent:', e);
      }
    }

    // ---------- Initialize Viewer ----------
    window.addEventListener('load', initViewer);


    // ALSO add localStorage polling
  setInterval(function() {
    const stored = localStorage.getItem('navigation_message');
    if (stored) {
      try {
        const message = JSON.parse(stored);
        // Check if recent (within last 2 seconds)
        if (message.timestamp && Date.now() - message.timestamp < 2000) {
          console.log('📨 From localStorage:', message);
          handleNavigationMessage({ data: message });
          // Clear after processing
          localStorage.removeItem('navigation_message');
        }
      } catch(err) {
        console.error('Error:', err);
      }
    }
  }, 500);

// ========== INFO PANEL DRAG & CLOSE FUNCTIONALITY ==========
(function() {
  const infoPanel = document.getElementById('info');
  const closeBtn = document.getElementById('closeBtn');
  const infoHeader = document.getElementById('info-header');

  let isDragging = false;
  let currentX, currentY, initialX, initialY;

  // Close button
  if (closeBtn) {
    closeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      infoPanel.style.display = 'none';
      document.getElementById('info-content').innerHTML = '';
    });
  }

  // Dragging
  if (infoHeader) {
    infoHeader.addEventListener('mousedown', dragStart);
  }
  
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', dragEnd);

  function dragStart(e) {
    if (e.target === closeBtn) return;
    
    isDragging = true;
    initialX = e.clientX - infoPanel.offsetLeft;
    initialY = e.clientY - infoPanel.offsetTop;
    infoHeader.style.cursor = 'grabbing';
    e.preventDefault();
  }

  function drag(e) {
    if (!isDragging) return;
    e.preventDefault();
    
    currentX = e.clientX - initialX;
    currentY = e.clientY - initialY;
    
    const maxX = window.innerWidth - infoPanel.offsetWidth;
    const maxY = window.innerHeight - infoPanel.offsetHeight;
    
    currentX = Math.max(0, Math.min(currentX, maxX));
    currentY = Math.max(0, Math.min(currentY, maxY));
    
    infoPanel.style.left = currentX + 'px';
    infoPanel.style.top = currentY + 'px';
    infoPanel.style.bottom = 'auto';
  }

  function dragEnd() {
    if (isDragging) {
      isDragging = false;
      if (infoHeader) infoHeader.style.cursor = 'move';
    }
  }

  if (infoHeader) {
    infoHeader.addEventListener('selectstart', (e) => {
      if (isDragging) e.preventDefault();
    });
  }
})();


  </script>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const logo = document.getElementById('company-logo');
  if (logo) {
    logo.style.position = 'fixed';
    logo.style.zIndex = '99999';
    logo.style.display = 'block';
    console.log('✅ Logo loaded');
  } else {
    console.error('❌ Logo not found');
  }
});
</script>

</body>
</html>